<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ZenTho Health Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent; /* Disable tap highlight on mobile */
        }
        
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --purple-primary: #8b5cf6;
            --purple-light: #a78bfa;
            --blue-primary: #3b82f6;
            --blue-light: #60a5fa;
            --green-primary: #10b981;
            --accent-gold: #fbbf24;
            --beautiful-green: #2ecc71;
            --danger-red: #ef4444;
            --danger-red-light: #f87171;
        }
        
        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #374151;
            --beautiful-green: #2edc71;
        }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            font-size: 14px;
            overflow-x: hidden;
        }

        /* Loading Screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: url('https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?q=80&w=2070&auto=format&fit=crop'); 
            background-size: cover;
            background-position: center;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease;
        }
        #loading-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6); /* Dark overlay */
        }
        .loading-content {
            z-index: 1;
            text-align: center;
            color: white;
        }
        .loading-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--beautiful-green);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--beautiful-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-top: 24px;
        }
        #google-connect-container {
            display: none; /* Hidden by default */
            margin-top: 32px;
            z-index: 1;
            text-align: center;
            pointer-events: auto; /* Ensure it's clickable */
        }
        #google-connect-btn {
            background: white;
            color: #444;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: none;
            cursor: pointer;
        }
        #google-connect-btn img {
            width: 24px;
            height: 24px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Custom Modal for Alerts/Confirms */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.6);
            z-index: 1999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-box {
            background: var(--bg-primary);
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 320px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-box {
            transform: scale(1);
        }
        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .modal-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }
        .modal-buttons {
            display: flex;
            gap: 12px;
        }
        .modal-buttons .btn-modern {
            flex: 1;
        }
        
        .nav-drawer {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            background: var(--bg-secondary);
            transition: left 0.3s ease;
            z-index: 1000;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
        }
        
        .nav-drawer.open {
            left: 0;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .btn-modern {
            padding: 8px 16px;
            border: 2px solid;
            border-radius: 8px;
            background: transparent;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .btn-purple { border-color: var(--purple-primary); color: var(--purple-primary); }
        .btn-purple:hover { background: var(--purple-primary); color: white; }
        .btn-blue { border-color: var(--blue-primary); color: var(--blue-primary); }
        .btn-blue:hover { background: var(--blue-primary); color: white; }
        .btn-green { border-color: var(--green-primary); color: var(--green-primary); }
        .btn-green:hover { background: var(--green-primary); color: white; }
        .btn-gold { border-color: var(--accent-gold); color: var(--accent-gold); }
        .btn-gold:hover { background: var(--accent-gold); color: white; }
        .btn-red { border-color: var(--danger-red); color: var(--danger-red); }
        .btn-red:hover { background: var(--danger-red); color: white; }
        
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin: 8px 0;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .step-circle {
            width: 200px;
            height: 200px;
            position: relative;
            margin: 0 auto;
        }
        
        .wave-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 160px;
            height: 160px;
            border-radius: 50%;
            overflow: hidden;
            background: rgba(59, 130, 246, 0.1);
            border: 3px solid var(--blue-primary);
        }
        
        .water-wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            background: linear-gradient(180deg, var(--blue-primary), var(--blue-light));
            transition: height 2s ease;
            overflow: hidden;
        }
        
        .water-wave::before {
            content: '';
            position: absolute;
            top: -20px;
            left: -50%;
            width: 200%;
            height: 40px;
            background: radial-gradient(ellipse, var(--blue-primary) 0%, transparent 70%);
            animation: wave 3s linear infinite;
        }
        
        @keyframes wave {
            0% { transform: translateX(0) rotate(0deg); }
            100% { transform: translateX(-50%) rotate(360deg); }
        }
        
        .screen {
            display: none;
            min-height: auto;
            padding: 16px;
            padding-top: 70px; /* Space for header */
            padding-bottom: 20px;
        }
        
        .screen.active {
            display: block;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.3s ease;
            border-radius: 8px;
            margin: 4px 8px;
            font-size: 14px;
            border: 1px solid transparent;
        }
        
        .nav-item:hover {
            border-color: var(--purple-primary);
            background: rgba(139, 92, 246, 0.1);
        }
        
        .nav-item i {
            width: 20px;
            margin-right: 12px;
            font-size: 16px;
        }

        .nav-item.emergency {
            color: var(--danger-red);
        }
        .nav-item.emergency:hover {
            border-color: var(--danger-red);
            background: rgba(239, 68, 68, 0.1);
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--purple-primary), var(--purple-light));
            border-radius: 3px;
            transition: width 1s ease;
        }
        
        .coin-icon {
            color: var(--purple-primary);
            animation: coinSpin 2s linear infinite;
        }
        
        @keyframes coinSpin {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }
        
        .input-field {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 12px;
            color: var(--text-primary);
            width: 100%;
            font-size: 13px;
            margin: 4px 0;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--purple-primary);
        }
        
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .toggle-switch.active {
            background: var(--purple-primary);
        }
        
        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        
        .toggle-switch.active::before {
            transform: translateX(24px);
        }
        
        .alarm-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: #ef4444;
            color: white;
            padding: 20px;
            border-radius: 12px;
            z-index: 2000;
            text-align: center;
            min-width: 300px;
            transition: all 0.3s ease;
            animation: pulse 1s infinite;
        }
        
        .alarm-notification.show {
            transform: translate(-50%, -50%) scale(1);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 12px;
            z-index: 1001;
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .popup.show {
            transform: translate(-50%, -50%) scale(1);
        }
        .mission-card {
            border-left: 4px solid var(--purple-primary);
            padding: 12px;
            margin: 8px 0;
            background: var(--bg-secondary);
            border-radius: 0 8px 8px 0;
        }
        .mission-card.completed {
            border-left-color: var(--green-primary);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }
        .stat-item {
            text-align: center;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--purple-primary);
        }
        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        .feature-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 24px;
            border: 2px solid;
        }
        .meditation-icon {
            background: rgba(139, 92, 246, 0.1);
            border-color: var(--purple-primary);
            color: var(--purple-primary);
        }
        .medicine-icon {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #ef4444;
        }
        .invite-icon {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--green-primary);
            color: var(--green-primary);
        }
        .tracking-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 16px 0;
        }
        .sound-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 12px 0;
        }
        .meditation-timer-display {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            color: var(--purple-primary);
            margin: 20px 0;
        }
        .mission-category {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
            background: var(--bg-secondary);
        }
        .security-setting {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .security-setting:last-child {
            border-bottom: none;
        }
        .daily-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 16px 0;
        }
        .day-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .day-btn.completed {
            border-color: var(--green-primary);
            background: var(--green-primary);
            color: white;
        }
        .day-btn.current {
            border-color: var(--purple-primary);
            background: var(--purple-primary);
            color: white;
        }

        /* --- LEADERBOARD STYLES --- */
        .leaderboard-card {
            display: flex;
            align-items: center;
            padding: 12px;
            gap: 16px;
            transition: all 0.3s ease;
        }
        .leaderboard-rank-icon {
            width: 32px;
            text-align: center;
            font-size: 1.75rem;
        }
        .leaderboard-rank-number {
            width: 32px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-secondary);
        }
        .leaderboard-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            font-size: 1.2rem;
            object-fit: cover;
        }

        .leaderboard-card-1 {
            background: linear-gradient(var(--bg-secondary), var(--bg-secondary)) padding-box,
                        linear-gradient(135deg, #FFD700, #F0A500) border-box;
            border: 2px solid transparent;
        }
        .leaderboard-card-2 {
            background: linear-gradient(var(--bg-secondary), var(--bg-secondary)) padding-box,
                        linear-gradient(135deg, #C0C0C0, #A9A9A9) border-box;
            border: 2px solid transparent;
        }
        .leaderboard-card-3 {
            background: linear-gradient(var(--bg-secondary), var(--bg-secondary)) padding-box,
                        linear-gradient(135deg, #CD7F32, #A0522D) border-box;
            border: 2px solid transparent;
        }
        .level-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 12px;
            color: white;
            background: var(--purple-primary);
        }

        /* --- EMERGENCY FEATURE STYLES --- */
        .emergency-btn-header {
            background-color: var(--danger-red);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .emergency-action-btn {
            padding: 20px;
            font-size: 1.1rem;
            font-weight: 700;
            border-radius: 12px;
            text-align: center;
            color: white;
            background: linear-gradient(135deg, var(--danger-red), var(--danger-red-light));
            border: none;
        }
        .first-aid-step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .first-aid-step i {
            margin-top: 4px;
            color: var(--purple-primary);
        }
    </style>
</head>
<body data-theme="light">
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-content">
            <h1 class="loading-title">ZenTho Health Pro</h1>
            <div class="loading-spinner"></div>
        </div>
        <div id="google-connect-container">
            <p class="text-white text-sm mb-3">Connect to sync your progress</p>
            <button id="google-connect-btn" onclick="signInWithGoogle()">
                <img src="https://www.google.com/favicon.ico" alt="Google icon">
                Connect with Google
            </button>
        </div>
    </div>

    <!-- Custom Alert/Confirm Modal -->
    <div class="modal-overlay" id="customModalOverlay">
        <div class="modal-box">
            <h3 class="modal-title" id="modalTitle">Alert</h3>
            <p class="modal-text" id="modalText">This is a message.</p>
            <div class="modal-buttons">
                <button class="btn-modern btn-red" id="modalCancelBtn">Cancel</button>
                <button class="btn-modern btn-green" id="modalOkBtn">OK</button>
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div class="overlay" onclick="closeDrawer()"></div>
    
    <!-- Alarm Notification -->
    <div class="alarm-notification" id="alarmNotification">
        <div id="alarmMessage">Alarm!</div>
        <div class="mt-4">
            <button class="btn-modern btn-red" onclick="dismissAlarm()">
                <i class="fas fa-times"></i>Dismiss
            </button>
            <button class="btn-modern btn-blue ml-2" onclick="snoozeAlarm()">
                <i class="fas fa-clock"></i>Snooze
            </button>
        </div>
    </div>
    
    <!-- Navigation Drawer -->
    <div class="nav-drawer" id="drawer">
        <div class="p-4 border-b" style="border-color: var(--border-color);">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center mr-3">
                    <i class="fas fa-heartbeat text-white"></i>
                </div>
                <div>
                    <h2 class="text-lg font-bold" style="color: var(--beautiful-green);">ZenTho Health Pro</h2>
                    <p class="text-xs opacity-75">Your Health Companion</p>
                </div>
            </div>
        </div>
        
        <nav class="mt-4">
            <a href="#" class="nav-item" onclick="showScreen('home')"><i class="fas fa-home"></i><div><div class="font-semibold">Home</div><div class="text-xs opacity-75">Dashboard Overview</div></div></a>
            <a href="#" class="nav-item" onclick="showScreen('profile')"><i class="fas fa-user"></i><div><div class="font-semibold">Profile & Level</div><div class="text-xs opacity-75">Your progress</div></div></a>
            <a href="#" class="nav-item" onclick="showScreen('steps')"><i class="fas fa-walking"></i><div><div class="font-semibold">Steps</div><div class="text-xs opacity-75">Track daily walking</div></div></a>
            <a href="#" class="nav-item" onclick="showScreen('water')"><i class="fas fa-tint"></i><div><div class="font-semibold">Water</div><div class="text-xs opacity-75">Hydration tracking</div></div></a>
            <a href="#" class="nav-item" onclick="showScreen('sleep')"><i class="fas fa-moon"></i><div><div class="font-semibold">Sleep</div><div class="text-xs opacity-75">Sleep quality monitor</div></div></a>
            <a href="#" class="nav-item" onclick="showScreen('meditation')"><i class="fas fa-leaf"></i><div><div class="font-semibold">Meditation</div><div class="text-xs opacity-75">Mindfulness & relaxation</div></div></a>
            <a href="#" class="nav-item" onclick="showScreen('medicine')"><i class="fas fa-pills"></i><div><div class="font-semibold">Medicine</div><div class="text-xs opacity-75">Medication reminders</div></div></a>
            <a href="#" class="nav-item" onclick="showScreen('mood')"><i class="fas fa-smile"></i><div><div class="font-semibold">Mood</div><div class="text-xs opacity-75">Emotional wellness</div></div></a>
            <a href="#" class="nav-item" onclick="showScreen('weight')"><i class="fas fa-weight"></i><div><div class="font-semibold">Weight</div><div class="text-xs opacity-75">Weight management</div></div></a>
            <a href="#" class="nav-item" onclick="showScreen('missions')"><i class="fas fa-tasks"></i><div><div class="font-semibold">Missions</div><div class="text-xs opacity-75">Daily challenges</div></div></a>
            <a href="#" class="nav-item" onclick="showScreen('rewards')"><i class="fas fa-coins"></i><div><div class="font-semibold">H Coins</div><div class="text-xs opacity-75">Rewards & earnings</div></div></a>
            <a href="#" class="nav-item" onclick="showScreen('leaderboard')"><i class="fas fa-trophy"></i><div><div class="font-semibold">Leaderboard</div><div class="text-xs opacity-75">Top 50 Winners</div></div></a>
            <a href="#" class="nav-item" onclick="showScreen('invite')"><i class="fas fa-user-friends"></i><div><div class="font-semibold">Invite Friends</div><div class="text-xs opacity-75">Share & earn rewards</div></div></a>
            <a href="#" class="nav-item" onclick="showScreen('withdraw')"><i class="fas fa-money-bill-wave"></i><div><div class="font-semibold">Withdraw</div><div class="text-xs opacity-75">Convert to USD</div></div></a>
            <a href="#" class="nav-item" onclick="showScreen('settings')"><i class="fas fa-cog"></i><div><div class="font-semibold">Settings</div><div class="text-xs opacity-75">App preferences</div></div></a>
            <a href="#" class="nav-item emergency" onclick="showScreen('emergency')"><i class="fas fa-first-aid"></i><div><div class="font-semibold">Emergency</div><div class="text-xs opacity-75">Immediate help</div></div></a>
        </nav>
    </div>
    
    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 z-50 p-4" style="background: var(--bg-primary); border-bottom: 1px solid var(--border-color);">
        <div class="flex items-center justify-between">
            <button onclick="toggleDrawer()" class="text-xl"><i class="fas fa-bars"></i></button>
            <h1 class="font-bold" style="color: var(--beautiful-green);">ZenTho Health Pro</h1>
            <div class="flex items-center gap-3">
                <button onclick="toggleTheme()" class="text-lg"><i class="fas fa-moon" id="themeIcon"></i></button>
            </div>
        </div>
    </header>
    
    <!-- ALL SCREENS -->
    <div id="home" class="screen active">
        <div class="text-center mb-6"><h2 class="text-xl font-bold mb-2">Welcome Back!</h2><p class="text-sm opacity-75">Track your health journey today</p></div>
        <div class="daily-buttons"><div class="day-btn completed">M</div><div class="day-btn completed">T</div><div class="day-btn completed">W</div><div class="day-btn current" onclick="dailyLogin()">T</div><div class="day-btn">F</div><div class="day-btn">S</div><div class="day-btn">S</div></div>
        <div class="step-circle mb-6"><div class="wave-container"><div class="water-wave" id="homeWaterWave"></div><div class="absolute inset-0 flex items-center justify-center flex-col"><div class="text-2xl font-bold" id="homeStepCount">3,721</div><div class="text-xs opacity-75">Steps</div><div class="text-xs opacity-60 mt-1">Goal: 5,000</div></div></div></div>
        <div class="stats-grid mb-6"><div class="stat-item"><div class="stat-value" id="homeWater">1.2L</div><div class="stat-label">Water</div></div><div class="stat-item"><div class="stat-value" id="homeSleep">7h 30m</div><div class="stat-label">Sleep</div></div><div class="stat-item"><div class="stat-value" id="homeCalories">186</div><div class="stat-label">Calories</div></div><div class="stat-item"><div class="stat-value" id="homeMeditation">15m</div><div class="stat-label">Meditation</div></div></div>
        <div class="card"><h3 class="font-semibold mb-3 text-sm">Quick Actions</h3><div class="grid grid-cols-2 gap-2"><button class="btn-modern btn-blue" onclick="showScreen('water')"><i class="fas fa-plus"></i>Add Water</button><button class="btn-modern btn-purple" onclick="showScreen('meditation')"><i class="fas fa-leaf"></i>Meditate</button><button class="btn-modern btn-green" onclick="showScreen('steps')"><i class="fas fa-play"></i>Start Walk</button><button class="btn-modern btn-gold" onclick="showScreen('missions')"><i class="fas fa-trophy"></i>Missions</button></div></div>
    </div>
    <div id="steps" class="screen">
        <div class="text-center mb-6"><div class="feature-icon" style="background: rgba(59, 130, 246, 0.1); border-color: var(--blue-primary); color: var(--blue-primary);"><i class="fas fa-walking"></i></div><h2 class="text-lg font-bold mb-2">Step Tracker</h2><p class="text-sm opacity-75">Track your daily walking activity</p></div>
        <div class="step-circle mb-6"><div class="wave-container"><div class="water-wave" id="stepWaterWave"></div><div class="absolute inset-0 flex items-center justify-center flex-col"><div class="text-2xl font-bold" id="stepCount">3,721</div><div class="text-xs opacity-75">Steps</div><div class="text-xs opacity-60 mt-1">Goal: 5,000</div></div></div></div>
        <div class="tracking-controls"><button class="btn-modern btn-green" id="startStepBtn" onclick="startStepTracking()"><i class="fas fa-play"></i>Start</button><button class="btn-modern btn-red" id="stopStepBtn" onclick="stopStepTracking()" style="display: none;"><i class="fas fa-stop"></i>Stop</button></div>
        <div class="card mb-4"><h3 class="font-semibold mb-3 text-sm">Step Goal Alarm</h3><div class="flex justify-between items-center"><span class="text-sm">Alert at 5,000 steps</span><div class="toggle-switch active" id="stepAlarmToggle" onclick="toggleStepAlarm()"></div></div></div>
        <div class="sound-control"><label class="text-sm">Sound Alerts:</label><div class="toggle-switch" id="stepSoundToggle" onclick="toggleStepSound()"></div></div>
        <div class="stats-grid mb-4"><div class="stat-item"><div class="stat-value" id="stepCalories">186</div><div class="stat-label">Calories</div></div><div class="stat-item"><div class="stat-value" id="stepDistance">2.8</div><div class="stat-label">Distance (km)</div></div><div class="stat-item"><div class="stat-value" id="stepTime">45</div><div class="stat-label">Active (min)</div></div><div class="stat-item"><div class="stat-value" id="stepStreak">7</div><div class="stat-label">Day Streak</div></div></div>
    </div>
    <div id="meditation" class="screen">
        <div class="text-center mb-6"><div class="feature-icon meditation-icon"><i class="fas fa-leaf"></i></div><h2 class="text-lg font-bold mb-2">Meditation Center</h2><p class="text-sm opacity-75">Find inner peace and mindfulness</p></div>
        <div class="card mb-4"><h3 class="font-semibold mb-3 text-sm">Meditation Timer</h3><div class="text-center mb-4"><div class="meditation-timer-display" id="meditationTimer">00:00</div><div class="text-xs opacity-75">Current Session</div></div><div class="mb-4"><label class="block text-sm mb-2">Set Timer (minutes):</label><input type="number" class="input-field" id="meditationDuration" placeholder="15" min="1" max="120"></div><div class="tracking-controls"><button class="btn-modern btn-purple" id="startMeditationBtn" onclick="startMeditation()"><i class="fas fa-play"></i>Start</button><button class="btn-modern btn-red" id="stopMeditationBtn" onclick="stopMeditation()" style="display: none;"><i class="fas fa-stop"></i>Stop</button></div></div>
        <div class="card mb-4"><h3 class="font-semibold mb-3 text-sm">Meditation Types</h3><div class="space-y-2"><button class="w-full btn-modern btn-purple" onclick="setMeditationType('mindfulness')"><i class="fas fa-brain"></i>Mindfulness (5-20 min)</button><button class="w-full btn-modern btn-blue" onclick="setMeditationType('breathing')"><i class="fas fa-wind"></i>Breathing (3-15 min)</button><button class="w-full btn-modern btn-green" onclick="setMeditationType('relaxation')"><i class="fas fa-spa"></i>Deep Relaxation (10-30 min)</button></div></div>
        <div class="sound-control"><label class="text-sm">Meditation Bell:</label><div class="toggle-switch active" id="meditationSoundToggle" onclick="toggleMeditationSound()"></div></div>
        <div class="stats-grid"><div class="stat-item"><div class="stat-value" id="totalMeditationTime">45</div><div class="stat-label">Total Min</div></div><div class="stat-item"><div class="stat-value" id="meditationStreak">12</div><div class="stat-label">Day Streak</div></div><div class="stat-item"><div class="stat-value" id="meditationSessions">8</div><div class="stat-label">Sessions</div></div><div class="stat-item"><div class="stat-value" id="meditationLevel">1</div><div class="stat-label">Level</div></div></div>
    </div>
    <div id="medicine" class="screen">
        <div class="text-center mb-6"><div class="feature-icon medicine-icon"><i class="fas fa-pills"></i></div><h2 class="text-lg font-bold mb-2">Medicine Reminder</h2><p class="text-sm opacity-75">Never miss your medication</p></div>
        <div class="card mb-4"><h3 class="font-semibold mb-3 text-sm">Add New Medicine</h3><div class="space-y-3"><input type="text" class="input-field" placeholder="Medicine name" id="medicineName"><div class="grid grid-cols-2 gap-2"><input type="time" class="input-field" id="medicineTime"><select class="input-field" id="medicineFrequency"><option value="daily">Daily</option><option value="twice">Twice Daily</option><option value="weekly">Weekly</option></select></div><button class="btn-modern btn-green w-full" onclick="addMedicine()"><i class="fas fa-plus"></i>Add Medicine</button></div></div>
        <div class="card mb-4"><h3 class="font-semibold mb-3 text-sm">Today's Schedule</h3><div id="medicineSchedule" class="space-y-2"></div></div>
        <div class="sound-control"><label class="text-sm">Medicine Alerts:</label><div class="toggle-switch active" id="medicineAlertToggle" onclick="toggleMedicineAlert()"></div></div>
        <div class="stats-grid"><div class="stat-item"><div class="stat-value" id="medicinesTotal">0</div><div class="stat-label">Total Meds</div></div><div class="stat-item"><div class="stat-value" id="medicinesTaken">0</div><div class="stat-label">Taken Today</div></div><div class="stat-item"><div class="stat-value" id="adherenceRate">0</div><div class="stat-label">Adherence %</div></div><div class="stat-item"><div class="stat-value" id="medicineStreak">0</div><div class="stat-label">Day Streak</div></div></div>
    </div>
    <div id="sleep" class="screen">
        <div class="text-center mb-6"><div class="feature-icon" style="background: rgba(139, 92, 246, 0.1); border-color: var(--purple-primary); color: var(--purple-primary);"><i class="fas fa-moon"></i></div><h2 class="text-lg font-bold mb-2">Sleep Tracker</h2><p class="text-sm opacity-75">Monitor your sleep quality</p></div>
        <div class="card mb-4"><div class="text-center mb-4"><div class="text-3xl font-bold text-purple-500">7h 30m</div><div class="text-xs opacity-75">Last Night's Sleep</div></div></div>
        <div class="card mb-4"><h3 class="font-semibold mb-3 text-sm">Sleep Schedule</h3><div class="grid grid-cols-2 gap-2 mb-3"><div><label class="block text-xs mb-1">Bedtime</label><input type="time" class="input-field" id="bedtime" value="22:30"></div><div><label class="block text-xs mb-1">Wake Time</label><input type="time" class="input-field" id="waketime" value="06:00"></div></div><button class="btn-modern btn-purple w-full mb-3" onclick="logSleep()"><i class="fas fa-save"></i>Save Sleep Schedule</button><div class="flex justify-between items-center"><span class="text-sm">Wake-up Alarm</span><div class="toggle-switch active" id="wakeAlarmToggle" onclick="toggleWakeAlarm()"></div></div></div>
        <div class="sound-control"><label class="text-sm">Sleep Reminders:</label><div class="toggle-switch" id="sleepReminderToggle" onclick="toggleSleepReminder()"></div></div>
        <div class="stats-grid"><div class="stat-item"><div class="stat-value">7.5h</div><div class="stat-label">Average</div></div><div class="stat-item"><div class="stat-value">85%</div><div class="stat-label">Efficiency</div></div><div class="stat-item"><div class="stat-value">22:45</div><div class="stat-label">Avg Bedtime</div></div><div class="stat-item"><div class="stat-value">06:15</div><div class="stat-label">Avg Wake</div></div></div>
    </div>
    <div id="missions" class="screen">
        <div class="text-center mb-6"><div class="feature-icon" style="background: rgba(251, 191, 36, 0.1); border-color: var(--accent-gold); color: var(--accent-gold);"><i class="fas fa-tasks"></i></div><h2 class="text-lg font-bold mb-2">Missions & Challenges</h2><p class="text-sm opacity-75">Complete challenges and earn rewards</p></div>
        <div class="mission-category"><h3 class="font-semibold mb-3 text-sm flex items-center"><i class="fas fa-star text-yellow-400 mr-2"></i>Daily Missions</h3><div class="space-y-3" id="dailyMissionsContainer"></div></div>
        <div class="mission-category"><h3 class="font-semibold mb-3 text-sm flex items-center"><i class="fas fa-calendar-week text-blue-500 mr-2"></i>Weekly Challenges</h3><div class="space-y-3" id="weeklyMissionsContainer"></div></div>
        <div class="mission-category"><h3 class="font-semibold mb-3 text-sm flex items-center"><i class="fas fa-calendar-alt text-purple-500 mr-2"></i>Monthly Goals</h3><div class="space-y-3" id="monthlyMissionsContainer"></div></div>
        <div class="mission-category"><h3 class="font-semibold mb-3 text-sm flex items-center"><i class="fas fa-crown text-red-500 mr-2"></i>Special Challenges</h3><div class="space-y-3" id="specialMissionsContainer"></div></div>
    </div>
    <div id="water" class="screen">
        <div class="text-center mb-6"><div class="feature-icon" style="background: rgba(59, 130, 246, 0.1); border-color: var(--blue-primary); color: var(--blue-primary);"><i class="fas fa-tint"></i></div><h2 class="text-lg font-bold mb-2">Water Tracker</h2><p class="text-sm opacity-75">Stay hydrated throughout the day</p></div>
        <div class="card mb-4"><div class="text-center mb-4"><div class="text-3xl font-bold text-blue-500" id="waterIntake">1.2L</div><div class="text-xs opacity-75">of 2.0L daily goal</div><div class="progress-bar mt-2"><div class="progress-fill" style="width: 60%" id="waterProgress"></div></div></div><button class="btn-modern btn-blue w-full" onclick="addWater()"><i class="fas fa-plus"></i>Add 250ml</button></div>
        <div class="card"><h3 class="font-semibold mb-3 text-sm">Today's Log</h3><div class="space-y-2" id="waterLog"></div></div>
    </div>
    <div id="mood" class="screen">
        <div class="text-center mb-6"><div class="feature-icon" style="background: rgba(251, 191, 36, 0.1); border-color: var(--accent-gold); color: var(--accent-gold);"><i class="fas fa-smile"></i></div><h2 class="text-lg font-bold mb-2">Mood Tracker</h2><p class="text-sm opacity-75">Track your emotional wellness</p></div>
        <div class="card mb-4"><h3 class="font-semibold mb-3 text-sm">How are you feeling?</h3><div class="grid grid-cols-5 gap-2 mb-4"><div class="text-center cursor-pointer p-2" onclick="setMood('very-sad')"><div class="text-2xl mb-1">😢</div><div class="text-xs">Sad</div></div><div class="text-center cursor-pointer p-2" onclick="setMood('sad')"><div class="text-2xl mb-1">😞</div><div class="text-xs">Low</div></div><div class="text-center cursor-pointer p-2" onclick="setMood('neutral')"><div class="text-2xl mb-1">😐</div><div class="text-xs">OK</div></div><div class="text-center cursor-pointer p-2" onclick="setMood('happy')"><div class="text-2xl mb-1">😊</div><div class="text-xs">Good</div></div><div class="text-center cursor-pointer p-2" onclick="setMood('very-happy')"><div class="text-2xl mb-1">😄</div><div class="text-xs">Great</div></div></div><textarea class="input-field mb-3" rows="2" placeholder="Add a note..." id="moodNote"></textarea><button class="btn-modern btn-purple w-full" onclick="saveMood()"><i class="fas fa-save"></i>Save Mood</button></div>
        <div class="stats-grid"><div class="stat-item"><div class="stat-value">😊</div><div class="stat-label">Today</div></div><div class="stat-item"><div class="stat-value">7.2</div><div class="stat-label">Avg Score</div></div><div class="stat-item"><div class="stat-value">12</div><div class="stat-label">Streak</div></div><div class="stat-item"><div class="stat-value">85%</div><div class="stat-label">Positive</div></div></div>
    </div>
    <div id="weight" class="screen">
        <div class="text-center mb-6"><div class="feature-icon" style="background: rgba(16, 185, 129, 0.1); border-color: var(--green-primary); color: var(--green-primary);"><i class="fas fa-weight"></i></div><h2 class="text-lg font-bold mb-2">Weight Tracker</h2><p class="text-sm opacity-75">Monitor your weight progress</p></div>
        <div class="card mb-4"><div class="text-center mb-4"><div class="text-3xl font-bold text-green-500">72.5 kg</div><div class="stat-label">Current Weight</div></div></div>
        <div class="card mb-4"><h3 class="font-semibold mb-3 text-sm">Log New Weight</h3><input type="number" class="input-field mb-3" placeholder="Enter weight (kg)" id="weightInput" step="0.1"><button class="btn-modern btn-green w-full" onclick="logWeight()"><i class="fas fa-plus"></i>Add Weight Entry</button></div>
        <div class="stats-grid"><div class="stat-item"><div class="stat-value">70.0</div><div class="stat-label">Goal (kg)</div></div><div class="stat-item"><div class="stat-value">-2.5</div><div class="stat-label">To Goal</div></div><div class="stat-item"><div class="stat-value">-1.2</div><div class="stat-label">This Month</div></div><div class="stat-item"><div class="stat-value">22.4</div><div class="stat-label">BMI</div></div></div>
    </div>
    <div id="invite" class="screen">
        <div class="text-center mb-6"><div class="feature-icon invite-icon"><i class="fas fa-user-friends"></i></div><h2 class="text-lg font-bold mb-2">Invite Friends</h2><p class="text-sm opacity-75">Share ZenTho Health+ and earn rewards</p></div>
        <div class="card mb-4"><h3 class="font-semibold mb-3 text-sm">Your Referral Link</h3><div class="flex gap-2"><input type="text" class="input-field flex-1" value="https://zentho.app/ref/ZTH3721" readonly id="referralLink"><button class="btn-modern btn-purple" onclick="copyReferralLink()"><i class="fas fa-copy"></i>Copy</button></div><div class="mt-3 grid grid-cols-2 gap-2"><button class="btn-modern btn-blue" onclick="shareWhatsApp()"><i class="fab fa-whatsapp"></i>WhatsApp</button><button class="btn-modern btn-purple" onclick="shareTwitter()"><i class="fab fa-twitter"></i>Twitter</button></div></div>
        <div class="card mb-4"><h3 class="font-semibold mb-3 text-sm">Daily Invites Progress</h3><div class="flex justify-between items-center mb-2"><span class="text-sm">Today's Invites</span><span class="text-sm font-bold" id="dailyInvites">2/5</span></div><div class="progress-bar"><div class="progress-fill" style="width: 40%" id="inviteProgress"></div></div><div class="text-xs opacity-75 mt-2">Complete 5 invites daily for bonus rewards!</div></div>
        <div class="card mb-4"><h3 class="font-semibold mb-3 text-sm">Referral Rewards</h3><div class="space-y-2 text-sm"><div class="flex justify-between"><span>• Friend joins</span><span class="text-purple-500 font-bold">+50 H Coins</span></div><div class="flex justify-between"><span>• 5 daily invites</span><span class="text-purple-500 font-bold">+25 H Coins</span></div><div class="flex justify-between"><span>• Friend reaches level 5</span><span class="text-purple-500 font-bold">+100 H Coins</span></div></div></div>
    </div>
    <div id="profile" class="screen">
        <div class="text-center mb-6">
            <div class="relative inline-block">
                <div class="w-24 h-24 bg-purple-500 rounded-full flex items-center justify-center mx-auto mb-3 border-4 border-purple-300">
                    <img id="profilePicture" src="https://placehold.co/96x96/8b5cf6/FFFFFF?text=U" class="w-full h-full rounded-full object-cover">
                </div>
                <div class="absolute -bottom-1 right-0 bg-purple-600 text-white text-sm font-bold rounded-full w-10 h-10 flex items-center justify-center border-2 border-white" id="profileLevelBadge">1</div>
            </div>
            <h2 class="text-2xl font-bold mt-2" id="profileDisplayName">John Doe</h2>
            <p class="text-sm opacity-75">Health Enthusiast</p>
        </div>
        
        <!-- Synced Account Display -->
        <div class="card mb-4">
            <h3 class="font-semibold mb-3 text-sm">Synced Account</h3>
            <div class="flex items-center gap-3">
                <i class="fab fa-google text-blue-500 text-xl"></i>
                <div class="flex-1">
                    <p class="font-semibold text-sm truncate" id="profileEmailDisplay">Not Connected</p>
                    <p class="text-xs opacity-75">Progress is synced</p>
                </div>
            </div>
        </div>

        <!-- LEVEL SYSTEM CARD -->
        <div class="card mb-4">
            <h3 class="font-semibold mb-3 text-sm">Level Progress</h3>
            <div class="flex justify-between items-center mb-1">
                <span class="font-bold text-purple-500" id="profileLevelText">Level 1</span>
                <span class="text-xs opacity-75" id="profileXP">0 / 100 XP</span>
            </div>
            <div class="progress-bar h-2 rounded">
                <div class="progress-fill h-2 rounded" id="profileXpProgress" style="width: 0%;"></div>
            </div>
        </div>
        <div class="card mb-4"><h3 class="font-semibold mb-3 text-sm">Personal & Medical Information</h3><div class="space-y-3"><input type="text" class="input-field" value="John Doe" id="profileName"><div class="grid grid-cols-2 gap-2"><input type="number" class="input-field" value="28" id="profileAge" placeholder="Age"><select class="input-field" id="profileGender"><option value="male">Male</option><option value="female">Female</option><option value="other">Other</option></select></div><div class="grid grid-cols-2 gap-2"><input type="number" class="input-field" value="175" id="profileHeight" placeholder="Height (cm)"><input type="number" class="input-field" value="72.5" id="profileWeight" placeholder="Weight (kg)" step="0.1"></div><div class="grid grid-cols-2 gap-2"><input type="text" class="input-field" id="profileBloodType" placeholder="Blood Type (e.g. A+)"><input type="text" class="input-field" id="profileAllergies" placeholder="Allergies"></div><button class="btn-modern btn-purple w-full" onclick="saveProfile()"><i class="fas fa-save"></i>Save Profile</button></div></div>
        <div class="stats-grid"><div class="stat-item"><div class="stat-value">23.7</div><div class="stat-label">BMI</div></div><div class="stat-item"><div class="stat-value">5000</div><div class="stat-label">Step Goal</div></div><div class="stat-item"><div class="stat-value">2.0L</div><div class="stat-label">Water Goal</div></div><div class="stat-item"><div class="stat-value">8h</div><div class="stat-label">Sleep Goal</div></div></div>
    </div>
    <div id="rewards" class="screen">
        <div class="text-center mb-6"><div class="text-4xl mb-3"><i class="fas fa-coins coin-icon"></i></div><div class="text-3xl font-bold text-purple-500 mb-2" id="totalCoinsDisplay">1,247</div><div class="text-sm opacity-75">H Coins Earned</div></div>
        <div class="card mb-4"><h3 class="font-semibold mb-3 text-sm">Today's Rewards</h3><div class="space-y-2"><div class="flex justify-between items-center"><span class="text-sm">Steps (3,721)</span><span class="text-purple-500 font-bold text-sm">+3 H</span></div><div class="flex justify-between items-center"><span class="text-sm">Meditation (15m)</span><span class="text-purple-500 font-bold text-sm">+2 H</span></div><div class="flex justify-between items-center"><span class="text-sm">Medicine Taken</span><span class="text-purple-500 font-bold text-sm">+1 H</span></div></div></div>
        <div class="card"><h3 class="font-semibold mb-3 text-sm">Earning Rules</h3><div class="space-y-1 text-sm"><div class="flex justify-between"><span>• 1,000 Steps</span><span class="text-purple-500">+1 H</span></div><div class="flex justify-between"><span>• 5min Meditation</span><span class="text-purple-500">+1 H</span></div><div class="flex justify-between"><span>• Take Medicine</span><span class="text-purple-500">+1 H</span></div><div class="flex justify-between"><span>• Daily Login</span><span class="text-purple-500">+5 H</span></div><div class="flex justify-between"><span>• Mission Completion</span><span class="text-purple-500">Varies</span></div></div></div>
    </div>
    <div id="withdraw" class="screen">
        <div class="text-center mb-6"><i class="fas fa-money-bill-wave text-4xl text-green-500 mb-3"></i><h2 class="text-lg font-bold mb-2">Withdraw H Coins</h2><p class="text-sm opacity-75">Convert your H Coins to USD</p></div>
        <div class="card mb-4"><div class="text-center mb-4"><div class="text-2xl font-bold text-purple-500 mb-1" id="withdrawTotalCoins">1,247 H Coins</div><div class="text-lg text-green-500" id="withdrawUsdValue">≈ $1.25 USD</div><div class="text-xs opacity-75 mt-1">Rate: 1,000 H = $1.00</div></div></div>
        <div class="card mb-4"><h3 class="font-semibold mb-3 text-sm">Withdrawal Details</h3><div class="space-y-3"><select class="input-field" id="walletType"><option value="">Select Wallet</option><option value="paypal">PayPal</option><option value="binance">Binance</option><option value="kbz">KBZ Pay</option></select><input type="text" class="input-field" placeholder="Wallet address/email" id="walletAddress"><input type="number" class="input-field" placeholder="Min: 10,000 H" id="withdrawAmount" min="10000"><input type="text" class="input-field" readonly id="usdEquivalent" placeholder="$0.00"><button class="btn-modern btn-gold w-full" onclick="processWithdraw()"><i class="fas fa-paper-plane"></i>Request Withdrawal</button></div></div>
        <div class="card"><h3 class="font-semibold mb-2 text-sm">Important Notes</h3><div class="text-xs opacity-75 space-y-1"><p>• Minimum: 10,000 H Coins ($10.00)</p><p>• Processing: 1-3 business days</p><p>• Rate: 1,000 H = $1.00 USD</p></div></div>
    </div>
    <div id="settings" class="screen">
        <div class="text-center mb-6"><i class="fas fa-cog text-4xl opacity-75 mb-3"></i><h2 class="text-lg font-bold">Settings</h2></div>
        <div class="card mb-4"><h3 class="font-semibold mb-3 text-sm">App Settings</h3><div class="space-y-3"><div class="flex justify-between items-center"><span class="text-sm">Dark Mode</span><div class="toggle-switch" id="darkModeToggle" onclick="toggleTheme()"></div></div><div class="flex justify-between items-center"><span class="text-sm">Notifications</span><div class="toggle-switch active" onclick="toggleSetting(this)"></div></div><div class="flex justify-between items-center"><span class="text-sm">Sound Effects</span><div class="toggle-switch active" onclick="toggleSetting(this)"></div></div><div class="flex justify-between items-center"><span class="text-sm">Vibration</span><div class="toggle-switch active" onclick="toggleSetting(this)"></div></div></div></div>
        <div class="card mb-4"><h3 class="font-semibold mb-3 text-sm">Account & Emergency</h3><div class="space-y-3"><div><label class="block text-xs mb-1">Emergency Contact Number</label><input type="tel" class="input-field" id="emergencyContactInput" placeholder="+959..."></div><button class="btn-modern btn-purple w-full" onclick="saveSettings()"><i class="fas fa-save"></i>Save Settings</button></div></div>
        <div class="card mb-4"><h3 class="font-semibold mb-3 text-sm">Data Management</h3><div class="space-y-2"><button class="btn-modern btn-blue w-full" onclick="exportData()"><i class="fas fa-download"></i>Export Data</button><button class="btn-modern btn-purple w-full" onclick="importData()"><i class="fas fa-upload"></i>Import Data</button><button class="btn-modern btn-red w-full" onclick="clearAllData()"><i class="fas fa-trash"></i>Clear All Data</button><button class="btn-modern btn-red w-full" onclick="deleteAccount()"><i class="fas fa-user-times"></i>Delete Account</button></div></div>
        <div class="card">
            <button class="btn-modern btn-red w-full" onclick="signOutUser()">
                <i class="fas fa-sign-out-alt"></i>Sign Out
            </button>
        </div>
        <div class="text-center text-xs opacity-50 mt-6" id="version-info">Version 1.7.1</div>
    </div>
    <div id="leaderboard" class="screen">
        <div class="text-center mb-6">
            <i class="fas fa-trophy text-4xl text-yellow-400 mb-3"></i>
            <h2 class="text-lg font-bold">Community Leaderboard</h2>
            <p class="text-sm opacity-75" id="leaderboardSubtitle">Top players and earners</p>
        </div>
        <div id="leaderboardContainer" class="space-y-2">
            <!-- Leaderboard items will be generated here by JavaScript -->
        </div>
    </div>
    <div id="emergency" class="screen">
        <div class="text-center mb-6">
            <div class="feature-icon" style="background: rgba(239, 68, 68, 0.1); border-color: var(--danger-red); color: var(--danger-red); animation: pulse-red 2s infinite;">
                <i class="fas fa-first-aid"></i>
            </div>
            <h2 class="text-2xl font-bold text-red-500">Emergency Help</h2>
            <p class="text-sm opacity-75">Use these options for immediate assistance.</p>
        </div>
        <div class="grid grid-cols-1 gap-4">
            <button class="emergency-action-btn" onclick="callEmergency()">
                <i class="fas fa-phone-alt mr-2"></i>Call Emergency (192)
            </button>
            <button class="emergency-action-btn" onclick="sendEmergencySMS()">
                <i class="fas fa-sms mr-2"></i>Text Emergency Contact
            </button>
             <button class="emergency-action-btn" style="background: linear-gradient(135deg, var(--blue-primary), var(--blue-light));" onclick="showScreen('emergency_treatment')">
                <i class="fas fa-book-medical mr-2"></i>First Aid Guide
            </button>
            <button class="emergency-action-btn" onclick="showLocation()">
                <i class="fas fa-map-marker-alt mr-2"></i>Show My Location
            </button>
        </div>
        <div class="card mt-6">
            <h3 class="font-semibold mb-3 text-sm">Your Medical Info</h3>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between"><span>Blood Type:</span><span class="font-bold" id="emergencyBloodType">Not Set</span></div>
                <div class="flex justify-between"><span>Allergies:</span><span class="font-bold" id="emergencyAllergies">Not Set</span></div>
                <div class="flex justify-between"><span>Emergency Contact:</span><span class="font-bold" id="emergencyContactDisplay">Not Set</span></div>
            </div>
        </div>
    </div>
    
    <!-- Emergency Treatment Screen -->
    <div id="emergency_treatment" class="screen">
        <div class="text-center mb-6">
            <div class="feature-icon" style="background: rgba(59, 130, 246, 0.1); border-color: var(--blue-primary); color: var(--blue-primary);">
                <i class="fas fa-book-medical"></i>
            </div>
            <h2 class="text-2xl font-bold">First Aid Guide</h2>
            <p class="text-sm opacity-75">Basic steps for common emergencies.</p>
        </div>
        <div class="card bg-red-500 text-white p-4 text-center text-sm font-semibold mb-4">
            This is a guide, not a substitute for professional medical help. Call emergency services immediately in a serious situation.
        </div>
        
        <div class="card">
            <h3 class="font-bold mb-3 text-lg text-red-500">Severe Bleeding</h3>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>Call Emergency Services:</b> This is the first and most crucial step.</span></div>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>Apply Pressure:</b> Use a clean cloth or bandage to apply firm, direct pressure to the wound.</span></div>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>Elevate the Injury:</b> If possible, raise the injured limb above the level of the heart.</span></div>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>Do Not Remove Cloth:</b> If blood soaks through, do not remove the cloth. Add more on top and continue pressure.</span></div>
        </div>
        
        <div class="card">
            <h3 class="font-bold mb-3 text-lg text-yellow-500">Burns (Minor)</h3>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>Cool the Burn:</b> Hold under cool (not cold) running water for 10-15 minutes.</span></div>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>Cover Loosely:</b> Use a sterile, non-stick bandage or clean cloth.</span></div>
            <div class="first-aid-step"><i class="fas fa-times-circle text-red-500"></i><span><b>Do NOT</b> use ice, butter, or ointments. Do not break blisters.</span></div>
        </div>
        
        <div class="card">
            <h3 class="font-bold mb-3 text-lg text-blue-500">Choking (Adult)</h3>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>Encourage Coughing:</b> If the person can speak or cough, encourage them to keep coughing.</span></div>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>5 Back Blows:</b> Give 5 sharp blows between the shoulder blades with the heel of your hand.</span></div>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>5 Abdominal Thrusts (Heimlich):</b> Stand behind the person. Place a fist above their navel. Grasp the fist with your other hand and give 5 quick, upward thrusts.</span></div>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>Alternate:</b> Continue with 5 blows and 5 thrusts until the object is dislodged or help arrives.</span></div>
        </div>

         <div class="card">
            <h3 class="font-bold mb-3 text-lg text-purple-500">Suspected Heart Attack</h3>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>Call Emergency Services Immediately.</b></span></div>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>Symptoms may include:</b> Chest pain/pressure, pain in arms/back/neck/jaw, shortness of breath, sweating, nausea, lightheadedness.</span></div>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>Rest Comfortably:</b> Have the person sit or lie down in a comfortable position.</span></div>
             <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>Aspirin:</b> If advised by emergency services and the person is not allergic, they can chew one adult aspirin.</span></div>
        </div>
        
        <div class="card">
            <h3 class="font-bold mb-3 text-lg text-orange-500">Stroke (Use F.A.S.T.)</h3>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>F - Face Drooping:</b> Does one side of the face droop or is it numb? Ask the person to smile.</span></div>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>A - Arm Weakness:</b> Is one arm weak or numb? Ask the person to raise both arms. Does one arm drift downward?</span></div>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>S - Speech Difficulty:</b> Is speech slurred, are they unable to speak, or are they hard to understand?</span></div>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>T - Time to Call Emergency:</b> If you see any of these signs, even if they go away, call for help immediately.</span></div>
        </div>

        <div class="card">
            <h3 class="font-bold mb-3 text-lg text-indigo-500">Seizure</h3>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>Stay Calm & Time It:</b> Note the time the seizure starts.</span></div>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>Protect from Injury:</b> Ease the person to the floor. Clear the area of hard or sharp objects. Place something soft under their head.</span></div>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>Turn on Side:</b> Gently roll the person onto one side to help them breathe.</span></div>
            <div class="first-aid-step"><i class="fas fa-times-circle text-red-500"></i><span><b>Do NOT</b> hold them down or put anything in their mouth.</span></div>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>Call for help if:</b> The seizure lasts more than 5 minutes, they have another seizure, they are injured, or they have trouble breathing afterwards.</span></div>
        </div>

        <div class="card">
            <h3 class="font-bold mb-3 text-lg text-green-500">Fractures & Sprains</h3>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>Rest:</b> Stop any activity and don't put weight on the injury.</span></div>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>Ice:</b> Apply an ice pack (wrapped in a cloth) for 15-20 minutes every 2-3 hours.</span></div>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>Compression:</b> Use an elastic bandage to wrap the area to reduce swelling, but not too tightly.</span></div>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>Elevation:</b> Keep the injured limb raised above the heart.</span></div>
            <div class="first-aid-step"><i class="fas fa-check-circle"></i><span><b>Seek medical help</b> if you suspect a fracture (deformity, severe pain, inability to move).</span></div>
        </div>
    </div>
    
    <!-- Popups -->
    <div class="popup" id="rewardPopup"><div class="text-center"><i class="fas fa-coins text-2xl text-purple-500 mb-2"></i><div class="font-bold" id="rewardText">+1 H Coin Earned!</div></div></div>
    <div class="popup" id="loginGiftPopup"><div class="text-center"><i class="fas fa-gift text-2xl text-gold mb-2"></i><div class="font-bold mb-2">Daily Login Gift!</div><div class="text-purple-500 font-bold">+5 H Coins & +20 XP</div><button class="btn-modern btn-purple mt-3" onclick="closeLoginGift()">Claim</button></div></div>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Firebase App (the core)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";
        // Firebase Authentication
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCgBHDgntJDV9EDWbbNmh2M2cLmZDP1iyU",
            authDomain: "zentho-health-pro.firebaseapp.com",
            projectId: "zentho-health-pro",
            storageBucket: "zentho-health-pro.appspot.com",
            messagingSenderId: "18698745942",
            appId: "1:18698745942:web:d808825913480d972963f7",
            measurementId: "G-2H6X545PSM"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        
        // Make auth and provider globally available to the main script
        window.firebase = {
            auth: getAuth(app),
            provider: new GoogleAuthProvider(),
            onAuthStateChanged,
            signInWithPopup,
            signOut
        };
    </script>

    <script>
        // --- SCRIPT START ---
        
        // --- GLOBAL VARIABLES ---
        let currentScreen = 'home';
        let stepCount = 0;
        let lastStepCountForXP = 0;
        let waterIntake = 0;
        let totalCoins = 0;
        let totalMeditationMinutes = 0;
        let meditationTime = 0;
        let meditationTimer = null;
        let meditationDurationSet = 15;
        let medicines = [];
        let lastLoginDate = ''; // For daily login check
        let alarmActive = false;
        let snoozeCount = 0;
        let stepTracking = false;
        let stepTimer = null;
        let lastBackPress = 0;
        const backPressThreshold = 2000;
        let currentMood = 'happy';
        let moodLoggedToday = false;
        let totalInvites = 0;
        let missionData = {};
        let beepInterval = null;
        let totalXP = 0;
        let emergencyContact = '';
        let medicalInfo = { bloodType: '', allergies: '' };
        let userProfile = {
            uid: null,
            email: null,
            name: 'John Doe',
            picture: 'https://placehold.co/96x96/8b5cf6/FFFFFF?text=U'
        };

        let alarms = {
            step: { enabled: true, triggered: false },
            wake: { enabled: true, time: '06:00' },
            meditation: { enabled: true },
            medicine: { enabled: true }
        };
        
        const sounds = {
            action: new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YSZ2T19PANqEAQAEuQwA//kIAe29ABHcvgAD3MAA//kIAe29ABHcvgAD3L4='),
            beep: new Audio('data:audio/wav;base64,UklGRkFvT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ1vT19PAAAAAP//8/UAAAD5//n/9v/y//L/8v/y//L/8v/z/+//6f/p/+n/6f/p/+n/6f/p/+n/7P/v//H/9v/6//3//f/9//3//f/9//3//f/9//8AAAABAAECAwQFBgcICQoLDA0ODxAREhMUFRYXGBkaGxwdHh8gISIjJCUmJygpKissLS4vMDEyMzQ1Njc4OTo7PD0+P0BBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWltcXV5fYGFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6e3x9fn+AgYKDhIWGh4iJiouMjY6PkJGSk5SVlpeYmZqbnJ2en6ChoqOkpaanqKmqq6ytrq+wsbKztLW2t7i5uru8vb6/wMHCw8TFxsfIycrLzM3Oz9DR0tPU1dbX2Nna29zd3t/g4eLj5OXm5+jp6uvs7e7v8PHy8/T19vf4+fr7/P3+/w==')
        };

        // --- MISSION DATA STRUCTURE ---
        const allMissions = {
            daily: [
                { id: 'daily_steps_5k', title: 'Walk 5,000 Steps', goal: 5000, reward: 15, unit: 'steps', key: 'stepCount' },
                { id: 'daily_water_2l', title: 'Drink 2L Water', goal: 2000, reward: 10, unit: 'ml', key: 'waterIntake' },
                { id: 'daily_meditate_10m', title: 'Meditate 10 Minutes', goal: 10, reward: 20, unit: 'min', key: 'totalMeditationMinutes' },
                { id: 'daily_mood_log', title: 'Log Your Mood', goal: 1, reward: 5, unit: 'log', key: 'moodLoggedToday' },
                { id: 'daily_medicine', title: 'Take All Medicines', goal: 1, reward: 10, unit: '%', key: 'medicineTakenPercent' }
            ],
            weekly: [
                { id: 'weekly_steps_35k', title: 'Walk 35,000 Steps', goal: 35000, reward: 100, unit: 'steps', key: 'stepCount' },
                { id: 'weekly_meditate_60m', title: 'Meditate for 60 Minutes', goal: 60, reward: 75, unit: 'min', key: 'totalMeditationMinutes' },
                { id: 'weekly_invites', title: 'Invite 3 Friends', goal: 3, reward: 150, unit: 'friends', key: 'totalInvites' }
            ],
            monthly: [
                { id: 'monthly_steps_150k', title: 'Walk 150,000 Steps', goal: 150000, reward: 500, unit: 'steps', key: 'stepCount' },
                { id: 'monthly_login_streak', title: 'Perfect Attendance', goal: 30, reward: 300, unit: 'days', key: 'loginStreak' }
            ],
            special: [
                { id: 'special_first_10k', title: 'First 10k Step Day', goal: 10000, reward: 50, unit: 'steps', key: 'stepCount' },
                { id: 'special_first_invite', title: 'Invite Your First Friend', goal: 1, reward: 25, unit: 'friends', key: 'totalInvites' },
                { id: 'special_profile_complete', title: 'Complete Your Profile', goal: 1, reward: 20, unit: '', key: 'profileComplete' }
            ]
        };
        
        // --- MODAL AND UI FUNCTIONS ---
        const modalOverlay = document.getElementById('customModalOverlay');
        const modalTitle = document.getElementById('modalTitle');
        const modalText = document.getElementById('modalText');
        const modalOkBtn = document.getElementById('modalOkBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        let modalOkCallback = null;
        let modalCancelCallback = null;

        function showCustomAlert(title, text, okCallback) { modalTitle.textContent = title; modalText.textContent = text; modalCancelBtn.style.display = 'none'; modalOkBtn.textContent = 'OK'; modalOverlay.classList.add('active'); modalOkCallback = okCallback; modalCancelCallback = null; }
        function showCustomConfirm(title, text, okCallback, cancelCallback) { modalTitle.textContent = title; modalText.textContent = text; modalCancelBtn.style.display = 'flex'; modalOkBtn.textContent = 'Confirm'; modalOverlay.classList.add('active'); modalOkCallback = okCallback; modalCancelCallback = cancelCallback; }
        function toggleDrawer() { document.getElementById('drawer').classList.toggle('open'); document.querySelector('.overlay').classList.toggle('active'); }
        function closeDrawer() { document.getElementById('drawer').classList.remove('open'); document.querySelector('.overlay').classList.remove('active'); }
        function showScreen(screen) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); const targetScreen = document.getElementById(screen); if (targetScreen) { targetScreen.classList.add('active'); currentScreen = screen; } if (screen === 'missions') renderMissions(); if (screen === 'leaderboard') renderLeaderboard(); if (screen === 'emergency') updateEmergencyInfo(); closeDrawer(); }
        function toggleTheme() { const body = document.body; const icon = document.getElementById('themeIcon'); const toggle = document.getElementById('darkModeToggle'); const isDark = body.getAttribute('data-theme') === 'dark'; body.setAttribute('data-theme', isDark ? 'light' : 'dark'); icon.className = isDark ? 'fas fa-moon' : 'fas fa-sun'; if (toggle) toggle.classList.toggle('active', !isDark); }
        function showRewardPopup(message) { const popup = document.getElementById('rewardPopup'); const text = document.getElementById('rewardText'); if (popup && text) { text.textContent = message; popup.classList.add('show'); setTimeout(() => popup.classList.remove('show'), 2000); } }

        // --- LEVEL SYSTEM FUNCTIONS ---
        const LEVEL_SCALING_FACTOR = 15;

        function calculateLevel(xp) {
            const level = Math.floor(Math.sqrt(xp / LEVEL_SCALING_FACTOR));
            const xpForCurrentLevel = Math.pow(level, 2) * LEVEL_SCALING_FACTOR;
            const xpForNextLevel = Math.pow(level + 1, 2) * LEVEL_SCALING_FACTOR;
            return {
                level: level + 1,
                xpInLevel: xp - xpForCurrentLevel,
                xpToNextLevel: xpForNextLevel - xpForCurrentLevel,
            };
        }

        function addXP(amount) {
            if (amount > 0) {
                const oldLevel = calculateLevel(totalXP).level;
                totalXP += amount;
                const newLevel = calculateLevel(totalXP).level;
                if (newLevel > oldLevel) {
                    showCustomAlert('Level Up!', `Congratulations! You've reached Level ${newLevel}!`);
                    earnReward(newLevel * 10, `Level ${newLevel} Bonus!`);
                }
                updateLevelDisplay();
            }
        }

        function updateLevelDisplay() {
            const levelInfo = calculateLevel(totalXP);
            const progressPercent = (levelInfo.xpInLevel / levelInfo.xpToNextLevel) * 100;

            document.getElementById('profileLevelBadge').textContent = levelInfo.level;
            document.getElementById('profileLevelText').textContent = `Level ${levelInfo.level}`;
            document.getElementById('profileXP').textContent = `${Math.floor(levelInfo.xpInLevel)} / ${Math.floor(levelInfo.xpToNextLevel)} XP`;
            document.getElementById('profileXpProgress').style.width = `${progressPercent}%`;
            document.getElementById('meditationLevel').textContent = levelInfo.level;
        }

        // --- DATA DISPLAY & UPDATE FUNCTIONS ---
        function updateAllDisplays() {
            updateStepDisplay();
            updateWaterDisplay();
            updateCoinsDisplay();
            updateMedicineSchedule();
            updateMissionsProgress();
            updateLevelDisplay();
            updateProfileUIDisplay();
            document.getElementById('homeMeditation').textContent = `${totalMeditationMinutes}m`;
        }
        function updateStepDisplay() {
            const newSteps = stepCount - lastStepCountForXP;
            if (newSteps > 0) {
                addXP(newSteps * 0.01);
                const coinsEarned = Math.floor(newSteps / 1000);
                if (coinsEarned > 0) {
                   earnReward(coinsEarned, `+${coinsEarned} H for walking!`);
                }
                lastStepCountForXP = stepCount;
            }

            document.querySelectorAll('#stepCount, #homeStepCount').forEach(el => el.textContent = stepCount.toLocaleString());
            const progressPercent = Math.min((stepCount / 5000) * 100, 100);
            document.querySelectorAll('#homeWaterWave, #stepWaterWave').forEach(wave => wave.style.height = `${progressPercent}%`);
            const calories = Math.round(stepCount * 0.05);
            document.querySelectorAll('#stepCalories, #homeCalories').forEach(el => el.textContent = calories);
            document.getElementById('stepDistance').textContent = (stepCount * 0.0008).toFixed(1);
        }
        function updateWaterDisplay() {
            const liters = (waterIntake / 1000).toFixed(1);
            document.querySelectorAll('#waterIntake, #homeWater').forEach(el => el.textContent = `${liters}L`);
            document.getElementById('waterProgress').style.width = `${Math.min((waterIntake / 2000) * 100, 100)}%`;
        }
        function updateCoinsDisplay() {
            document.querySelectorAll('#totalCoins, #totalCoinsDisplay, #withdrawTotalCoins').forEach(el => el.textContent = `${Math.round(totalCoins).toLocaleString()}`);
            document.getElementById('withdrawUsdValue').textContent = `≈ $${(totalCoins / 1000).toFixed(2)} USD`;
        }
        function updateMedicineSchedule() {
            const schedule = document.getElementById('medicineSchedule');
            if (schedule) {
                schedule.innerHTML = medicines.map((med, index) => `
                    <div class="flex justify-between items-center py-2 px-3 rounded-lg" style="background: var(--bg-primary);">
                        <div><div class="font-semibold text-sm">${med.name}</div><div class="text-xs opacity-75">${med.time}</div></div>
                        <button class="btn-modern ${med.taken ? 'btn-green' : 'btn-purple'}" onclick="takeMedicine(${index})"><i class="fas ${med.taken ? 'fa-check' : 'fa-clock'}"></i>${med.taken ? 'Taken' : 'Take'}</button>
                    </div>`).join('');
            }
        }
        function updateProfileUIDisplay() {
            document.getElementById('profileEmailDisplay').textContent = userProfile.email || 'Not Connected';
            document.getElementById('profileDisplayName').textContent = userProfile.name;
            document.getElementById('profileName').value = userProfile.name;
            document.getElementById('profilePicture').src = userProfile.picture;
            document.getElementById('profilePicture').onerror = () => {
                document.getElementById('profilePicture').src = 'https://placehold.co/96x96/8b5cf6/FFFFFF?text=U';
            };
        }
        
        // --- MISSION FUNCTIONS ---
        function renderMissions() {
            Object.keys(allMissions).forEach(category => {
                const container = document.getElementById(`${category}MissionsContainer`);
                if (container) {
                    container.innerHTML = allMissions[category].map(mission => {
                        const progress = missionData[mission.id] || { current: 0, claimed: false };
                        const currentVal = getCurrentMissionValue(mission.key);
                        const percent = Math.min((currentVal / mission.goal) * 100, 100);
                        const isComplete = currentVal >= mission.goal;
                        
                        let buttonHtml = `<div class="text-purple-500 font-bold text-sm">+${mission.reward} H</div>`;
                        if (isComplete) {
                            if (progress.claimed) {
                                buttonHtml = `<div class="text-green-500 font-bold text-sm"><i class="fas fa-check-circle"></i> Claimed</div>`;
                            } else {
                                buttonHtml = `<button class="btn-modern btn-gold text-xs py-1 px-2" onclick="claimMissionReward('${mission.id}', ${mission.reward})">Claim</button>`;
                            }
                        }

                        return `
                            <div class="mission-card ${isComplete ? 'completed' : ''}" id="mission-card-${mission.id}">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <div class="font-semibold text-sm">${mission.title}</div>
                                        <div class="text-xs opacity-75">Progress: ${currentVal.toLocaleString()}/${mission.goal.toLocaleString()} ${mission.unit}</div>
                                    </div>
                                    ${buttonHtml}
                                </div>
                                <div class="progress-bar mt-2">
                                    <div class="progress-fill" style="width: ${percent}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            });
        }

        function getCurrentMissionValue(key) {
            if (key === 'medicineTakenPercent') {
                const totalMeds = medicines.length;
                if (totalMeds === 0) return 1; // 100% if no meds
                const takenMeds = medicines.filter(m => m.taken).length;
                return takenMeds / totalMeds;
            }
            return window[key] || 0;
        }

        function updateMissionsProgress() {
            if (currentScreen === 'missions') {
                renderMissions();
            }
        }

        function claimMissionReward(missionId, reward) {
            if (!missionData[missionId]) {
                missionData[missionId] = { current: 0, claimed: false };
            }
            if (!missionData[missionId].claimed) {
                missionData[missionId].claimed = true;
                earnReward(reward, `Mission Complete!`);
                addXP(reward * 2);
                renderMissions();
                saveData();
            }
        }

        // --- LEADERBOARD FUNCTIONS ---
        function generateLeaderboardData() {
            const users = [];
            const names = ["Aung", "Thura", "Hla", "Mya", "Kyaw", "Nilar", "Zaw", "Su", "Min", "Khin"];
            const lastNames = ["Myo", "Win", "Tun", "Latt", "Htun", "Phyu"];
            for (let i = 0; i < 49; i++) {
                const randomXP = Math.random() * 50000 + 500;
                const randomCoins = (randomXP / 10) * (Math.random() + 0.5);
                users.push({
                    name: `${names[Math.floor(Math.random() * names.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`,
                    xp: randomXP,
                    level: calculateLevel(randomXP).level,
                    coins: randomCoins,
                    avatar: `<i class="fas fa-user"></i>`
                });
            }
            users.push({
                name: `You (${userProfile.name})`,
                xp: totalXP,
                level: calculateLevel(totalXP).level,
                coins: totalCoins,
                avatar: `<img src="${userProfile.picture}" class="w-full h-full object-cover">`
            });

            users.sort((a, b) => b.xp - a.xp);
            
            return users.map((user, index) => ({...user, rank: index + 1}));
        }

        function renderLeaderboard() {
            const container = document.getElementById('leaderboardContainer');
            if (!container) return;

            const users = generateLeaderboardData();
            const dollarEarners = users.filter(u => u.coins >= 10000).length;
            
            document.getElementById('leaderboardSubtitle').textContent = `${dollarEarners} players have earned cash rewards!`;

            let html = '';
            users.forEach(user => {
                let rankDisplay;
                let cardClass = 'card leaderboard-card';

                if (user.rank === 1) {
                    rankDisplay = `<div class="leaderboard-rank-icon text-yellow-400"><i class="fas fa-crown"></i></div>`;
                    cardClass += ' leaderboard-card-1';
                } else if (user.rank === 2) {
                    rankDisplay = `<div class="leaderboard-rank-icon text-gray-400"><i class="fas fa-medal"></i></div>`;
                    cardClass += ' leaderboard-card-2';
                } else if (user.rank === 3) {
                    rankDisplay = `<div class="leaderboard-rank-icon text-yellow-600"><i class="fas fa-medal"></i></div>`;
                    cardClass += ' leaderboard-card-3';
                } else {
                    rankDisplay = `<div class="leaderboard-rank-number">${user.rank}</div>`;
                }
                
                if(user.name.startsWith("You")) {
                    cardClass += ' border-2 border-purple-500';
                }

                html += `
                    <div class="${cardClass}">
                        ${rankDisplay}
                        <div class="leaderboard-avatar">${user.avatar}</div>
                        <div class="flex-1">
                            <div class="font-bold text-sm">${user.name}</div>
                            <div class="text-xs opacity-75">${Math.floor(user.xp).toLocaleString()} XP</div>
                        </div>
                        <div class="level-badge">Lv. ${user.level}</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // --- CORE LOGIC & FEATURE FUNCTIONS ---
        function earnReward(amount, message) { totalCoins += amount; updateCoinsDisplay(); showRewardPopup(message); }
        function addWater() {
            waterIntake += 250;
            const timeStr = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const waterLog = document.getElementById('waterLog');
            if (waterLog) {
                const newEntry = document.createElement('div');
                newEntry.className = 'flex justify-between items-center py-1';
                newEntry.innerHTML = `<span class="text-sm">${timeStr}</span><span class="text-sm">250ml</span>`;
                waterLog.insertBefore(newEntry, waterLog.firstChild);
                while (waterLog.children.length > 10) waterLog.removeChild(waterLog.lastChild);
            }
            addXP(2);
            updateAllDisplays();
            saveData();
        }
        function addMedicine() {
            const name = document.getElementById('medicineName').value;
            const time = document.getElementById('medicineTime').value;
            if (name && time) {
                medicines.push({ name, time, frequency: document.getElementById('medicineFrequency').value, taken: false });
                document.getElementById('medicineName').value = '';
                updateAllDisplays();
                saveData();
            }
        }
        function takeMedicine(index) {
            if (typeof index === 'number' && !medicines[index].taken) {
                medicines[index].taken = true;
                playSound('action');
                earnReward(1, 'Medicine Taken!');
                addXP(10);
                updateAllDisplays();
                saveData();
            }
        }
        function startMeditation() {
            meditationDurationSet = parseInt(document.getElementById('meditationDuration').value) || 15;
            document.getElementById('startMeditationBtn').style.display = 'none';
            document.getElementById('stopMeditationBtn').style.display = 'inline-flex';
            meditationTime = 0;
            meditationTimer = setInterval(() => {
                meditationTime++;
                const minutes = Math.floor(meditationTime / 60);
                const seconds = meditationTime % 60;
                document.getElementById('meditationTimer').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                if (minutes >= meditationDurationSet) {
                    stopMeditation();
                    showAlarm(`🧘‍♂️ Meditation complete!`, 'meditation');
                    return;
                }
            }, 1000);
        }
        function stopMeditation() {
            document.getElementById('startMeditationBtn').style.display = 'inline-flex';
            document.getElementById('stopMeditationBtn').style.display = 'none';
            if (meditationTimer) clearInterval(meditationTimer);
            meditationTimer = null;
            const minutesMeditated = Math.floor(meditationTime / 60);
            if (minutesMeditated > 0) {
                totalMeditationMinutes += minutesMeditated;
                const coinsEarned = Math.floor(minutesMeditated / 5);
                if (coinsEarned > 0) {
                    earnReward(coinsEarned, `+${coinsEarned} H for meditation!`);
                }
                addXP(minutesMeditated * 5);
            }
            updateAllDisplays();
            saveData();
        }
        function playSound(type) { if (sounds[type]) sounds[type].play().catch(() => {}); }
        function setMood(mood) { currentMood = mood; /* Add visual feedback for selection */ }
        function saveMood() { moodLoggedToday = true; addXP(5); updateAllDisplays(); saveData(); showCustomAlert("Success", "Mood logged for today!"); }
        function logWeight() { if (document.getElementById('weightInput').value) { addXP(5); updateAllDisplays(); saveData(); showCustomAlert("Success", "Weight logged!"); } }
        function logSleep() { if (document.getElementById('bedtime').value && document.getElementById('waketime').value) { addXP(10); updateAllDisplays(); saveData(); showCustomAlert("Success", "Sleep schedule saved!"); } }
        
        function saveProfile() { 
            userProfile.name = document.getElementById('profileName').value;
            medicalInfo.bloodType = document.getElementById('profileBloodType').value;
            medicalInfo.allergies = document.getElementById('profileAllergies').value;
            showCustomAlert('Success', 'Profile saved!'); 
            addXP(25); 
            updateAllDisplays(); 
            saveData(); 
        }

        function saveSettings() {
            emergencyContact = document.getElementById('emergencyContactInput').value;
            showCustomAlert('Success', 'Settings saved!');
            saveData();
        }

        // --- AUTHENTICATION FUNCTIONS ---
        async function signInWithGoogle() {
            const { auth, provider, signInWithPopup } = window.firebase;
            try {
                const result = await signInWithPopup(auth, provider);
                // The onAuthStateChanged listener will handle the rest.
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                showCustomAlert("Sign-In Failed", "Could not connect to Google. Please try again.");
            }
        }

        async function signOutUser() {
            showCustomConfirm("Sign Out?", "Are you sure you want to sign out? Your progress is saved.", async () => {
                const { auth, signOut } = window.firebase;
                try {
                    await signOut(auth);
                    // The onAuthStateChanged listener will handle UI reset.
                    // For a clean reset, we can clear local storage and reload.
                    localStorage.clear();
                    location.reload();
                } catch (error) {
                    console.error("Sign Out Error:", error);
                    showCustomAlert("Error", "Could not sign out. Please try again.");
                }
            });
        }


        function copyReferralLink() { document.getElementById('referralLink').select(); document.execCommand('copy'); showRewardPopup('Referral Link Copied!'); }
        function shareWhatsApp() { window.open(`https://wa.me/?text=Join me on ZenTho Health+! ${document.getElementById('referralLink').value}`); earnReward(5, 'Invite Shared!'); totalInvites++; addXP(50); updateAllDisplays(); saveData(); }
        function shareTwitter() { window.open(`https://twitter.com/intent/tweet?text=Join me on ZenTho Health+! ${document.getElementById('referralLink').value}`); earnReward(5, 'Invite Shared!'); totalInvites++; addXP(50); updateAllDisplays(); saveData(); }
        
        function dailyLogin() { 
            const today = new Date().toLocaleDateString();
            if (lastLoginDate !== today) {
                showDailyLoginGift();
            } else {
                showCustomAlert("Already Claimed", "You have already claimed your daily login gift today.");
            }
        }
        function showDailyLoginGift() { document.getElementById('loginGiftPopup').classList.add('show'); }
        function closeLoginGift() { 
            document.getElementById('loginGiftPopup').classList.remove('show'); 
            earnReward(5, 'Daily Login Bonus!'); 
            addXP(20); 
            lastLoginDate = new Date().toLocaleDateString();
            saveData(); 
        }
        function calculateUSDEquivalent() { const amount = document.getElementById('withdrawAmount').value; document.getElementById('usdEquivalent').value = amount ? `$${(amount / 1000).toFixed(2)}` : ''; }
        function setMeditationType(type) { console.log("Meditation type set to:", type); }
        function toggleSetting(toggle) { toggle.classList.toggle('active'); }
        function toggleStepAlarm() { const t = document.getElementById('stepAlarmToggle'); t.classList.toggle('active'); alarms.step.enabled = t.classList.contains('active'); }
        function toggleWakeAlarm() { const t = document.getElementById('wakeAlarmToggle'); t.classList.toggle('active'); alarms.wake.enabled = t.classList.contains('active'); }
        function toggleStepSound() { document.getElementById('stepSoundToggle').classList.toggle('active'); }
        function toggleMeditationSound() { document.getElementById('meditationSoundToggle').classList.toggle('active'); }
        function toggleMedicineAlert() { const t = document.getElementById('medicineAlertToggle'); t.classList.toggle('active'); alarms.medicine.enabled = t.classList.contains('active'); }
        function toggleSleepReminder() { document.getElementById('sleepReminderToggle').classList.toggle('active'); }

        // --- ALARM & NATIVE DEVICE FUNCTIONS ---
        function showAlarm(message, alarmType) {
            if (alarmActive) return;
            alarmActive = true;
            document.getElementById('alarmMessage').textContent = message;
            document.getElementById('alarmNotification').classList.add('show');
            if ('vibrate' in navigator) navigator.vibrate([200, 100, 200, 100, 200]);

            if (['meditation', 'wake', 'medicine'].includes(alarmType)) {
                let beepCount = 0;
                if (beepInterval) clearInterval(beepInterval);
                beepInterval = setInterval(() => {
                    if (beepCount < 3) {
                        playSound('beep');
                        beepCount++;
                    } else {
                        clearInterval(beepInterval);
                        beepInterval = null;
                    }
                }, 600);
            }
        }
        function dismissAlarm() {
            alarmActive = false;
            snoozeCount = 0;
            document.getElementById('alarmNotification').classList.remove('show');
            if (beepInterval) {
                clearInterval(beepInterval);
                beepInterval = null;
            }
        }
        function snoozeAlarm() {
            snoozeCount++;
            dismissAlarm();
            if (snoozeCount <= 3) {
                setTimeout(() => showAlarm(`Snoozed Alarm (${snoozeCount}/3)`), 5 * 60 * 1000);
            }
        }
        function startAlarmMonitoring() { setInterval(() => { checkWakeAlarm(); checkMedicineAlarms(); }, 30000); }
        function checkWakeAlarm() { if (!alarms.wake.enabled) return; const now = new Date(); const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`; if (currentTime === document.getElementById('waketime').value && !alarmActive) showAlarm('⏰ Good Morning! Time to wake up!', 'wake'); }
        function checkMedicineAlarms() { if (!alarms.medicine.enabled) return; const now = new Date(); const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`; medicines.forEach(med => { if (med.time === currentTime && !med.taken && !alarmActive) showAlarm(`💊 Time to take ${med.name}!`, 'medicine'); }); }
        
        function startStepTracking() { 
            if (stepTracking) return; 
            stepTracking = true; 
            document.getElementById('startStepBtn').style.display = 'none'; 
            document.getElementById('stopStepBtn').style.display = 'inline-flex'; 
            if (typeof window.pedometer === 'undefined') {
                console.log("Pedometer not found. Using simulator.");
                stepTimer = setInterval(() => { stepCount += Math.floor(Math.random() * 3) + 1; updateAllDisplays(); }, 2000);
            } else {
                 window.pedometer.startPedometerUpdates(pData => { 
                    stepCount = pData.numberOfSteps; 
                    updateAllDisplays(); 
                }, (error) => {
                    console.error("Pedometer error:", error);
                    showCustomAlert("Pedometer Error", "Could not start step tracking. Please check permissions.");
                });
            }
        }

        function stopStepTracking() { 
            if (!stepTracking) return; 
            stepTracking = false; 
            document.getElementById('startStepBtn').style.display = 'inline-flex'; 
            document.getElementById('stopStepBtn').style.display = 'none'; 
            if (typeof window.pedometer !== 'undefined') {
                window.pedometer.stopPedometerUpdates();
            }
            if (stepTimer) {
                clearInterval(stepTimer); 
                stepTimer = null;
            }
            saveData(); 
        }

        function onBackKeyDown(e) { e.preventDefault(); if (currentScreen !== 'home') { showScreen('home'); } else { const timePeriod = new Date().getTime(); if (timePeriod - lastBackPress < backPressThreshold) { if (navigator.app) navigator.app.exitApp(); } else { lastBackPress = timePeriod; showRewardPopup('Press back again to exit'); } } }

        // --- EMERGENCY FUNCTIONS ---
        function updateEmergencyInfo() {
            document.getElementById('emergencyBloodType').textContent = medicalInfo.bloodType || 'Not Set';
            document.getElementById('emergencyAllergies').textContent = medicalInfo.allergies || 'Not Set';
            document.getElementById('emergencyContactDisplay').textContent = emergencyContact || 'Not Set';
        }
        function callEmergency() {
            window.location.href = 'tel:192';
        }
        function sendEmergencySMS() {
            if (!emergencyContact) {
                showCustomAlert("No Contact", "Please set an emergency contact in Settings first.");
                return;
            }
            const message = `Emergency! I need help. My current location is being determined. From ZenTho Health Pro.`;
            window.location.href = `sms:${emergencyContact}?body=${encodeURIComponent(message)}`;
        }
        function showLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    window.open(`https://www.google.com/maps?q=${lat},${lon}`, '_blank');
                }, () => {
                    showCustomAlert("Location Error", "Could not get your location. Please enable location services.");
                });
            } else {
                showCustomAlert("Unsupported", "Geolocation is not supported by your browser.");
            }
        }

        // --- DATA MANAGEMENT FUNCTIONS ---
        function saveData() { 
            // Only save if a user is logged in
            if (!userProfile.uid) return;
            const data = { 
                stepCount, lastStepCountForXP, waterIntake, totalCoins, totalMeditationMinutes, 
                medicines, lastLoginDate, moodLoggedToday, totalInvites, missionData, alarms, 
                totalXP, emergencyContact, medicalInfo, userProfile,
                lastSaved: new Date().toISOString() 
            }; 
            localStorage.setItem(`zenThoHealthData_${userProfile.uid}`, JSON.stringify(data)); 
        }
        function loadSavedData(uid) {
            const saved = localStorage.getItem(`zenThoHealthData_${uid}`);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    // Set defaults for new values if they don't exist in old save data
                    totalXP = data.totalXP || 0;
                    lastStepCountForXP = data.lastStepCountForXP || data.stepCount || 0;
                    lastLoginDate = data.lastLoginDate || '';
                    emergencyContact = data.emergencyContact || '';
                    medicalInfo = data.medicalInfo || { bloodType: '', allergies: '' };
                    userProfile = data.userProfile || userProfile; // Keep the auth profile if local is missing
                    
                    Object.assign(window, data);

                    // Populate settings fields after loading
                    document.getElementById('emergencyContactInput').value = emergencyContact;
                    document.getElementById('profileBloodType').value = medicalInfo.bloodType;
                    document.getElementById('profileAllergies').value = medicalInfo.allergies;

                } catch (error) { console.error('Error loading data:', error); }
            }
            updateAllDisplays();
        }
        function exportData() { const dataStr = JSON.stringify(JSON.parse(localStorage.getItem(`zenThoHealthData_${userProfile.uid}`) || '{}'), null, 2); const blob = new Blob([dataStr], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'zentho-health-data.json'; a.click(); URL.revokeObjectURL(url); }
        function importData() { const input = document.createElement('input'); input.type = 'file'; input.accept = '.json'; input.onchange = e => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = e => { try { localStorage.setItem(`zenThoHealthData_${userProfile.uid}`, e.target.result); loadSavedData(userProfile.uid); showCustomAlert('Success', 'Data imported successfully!'); } catch (error) { showCustomAlert('Error', 'Invalid file format'); } }; reader.readAsText(file); } }; input.click(); }
        function clearAllData() { showCustomConfirm('Clear All Data?', 'This will reset everything for this account, including your level and coins. This cannot be undone.', () => { localStorage.removeItem(`zenThoHealthData_${userProfile.uid}`); location.reload(); }); }
        function deleteAccount() { showCustomConfirm('Delete Account?', 'This is permanent and will erase all your data.', () => showCustomAlert('Request Submitted', 'Your account deletion request has been submitted.')); }
        function processWithdraw() { 
            if (!userProfile.email) {
                showCustomAlert('Not Connected', 'Please connect with Google in your profile to enable withdrawals.');
                return;
            }
            const amount = document.getElementById('withdrawAmount').value; 
            if (!document.getElementById('walletType').value || !document.getElementById('walletAddress').value || !amount) { showCustomAlert('Error', 'Please fill all fields'); return; } 
            if (amount < 10000) { showCustomAlert('Error', 'Minimum withdrawal is 10,000 H Coins.'); return; } 
            if (amount > totalCoins) { showCustomAlert('Error', 'Insufficient balance'); return; } 
            showCustomConfirm('Confirm Withdrawal', `Withdraw ${amount} H Coins?`, () => { totalCoins -= amount; updateAllDisplays(); saveData(); showCustomAlert('Success', 'Withdrawal request submitted!'); }); 
        }

        // --- INITIALIZATION ---
        function initializeApp() {
            const { auth, onAuthStateChanged } = window.firebase;
            
            onAuthStateChanged(auth, (user) => {
                const loadingScreen = document.getElementById('loading-screen');
                if (user) {
                    // User is signed in.
                    userProfile = {
                        uid: user.uid,
                        email: user.email,
                        name: user.displayName,
                        picture: user.photoURL,
                    };

                    loadSavedData(user.uid);
                    
                    if (loadingScreen) {
                        loadingScreen.style.opacity = '0';
                        setTimeout(() => loadingScreen.style.display = 'none', 500);
                    }
                    
                    startApp();

                } else {
                    // User is signed out.
                    // Show the login button on the loading screen.
                    if (loadingScreen) {
                        loadingScreen.style.opacity = '1';
                        loadingScreen.style.display = 'flex';
                        document.querySelector('.loading-spinner').style.display = 'none';
                        document.getElementById('google-connect-container').style.display = 'block';
                    }
                }
            });
        }
        
        function startApp() {
            // Functions that should run once the app is ready and user is logged in
            if (document.body.dataset.native === "true") { 
                document.addEventListener('backbutton', onBackKeyDown, false); 
            }
            document.getElementById('withdrawAmount')?.addEventListener('input', calculateUSDEquivalent);
            startAlarmMonitoring();
            
            const today = new Date().toLocaleDateString();
            if (lastLoginDate !== today) {
                setTimeout(showDailyLoginGift, 3000);
            }
        }

        function onDeviceReady() { 
            console.log("Device Ready. Setting up native features."); 
            document.body.dataset.native = "true";
        }
        
        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', initializeApp);
        document.addEventListener('deviceready', onDeviceReady, false);
        modalOkBtn.addEventListener('click', () => { modalOverlay.classList.remove('active'); if (typeof modalOkCallback === 'function') modalOkCallback(); });
        modalCancelBtn.addEventListener('click', () => { modalOverlay.classList.remove('active'); if (typeof modalCancelCallback === 'function') modalCancelCallback(); });
        setInterval(saveData, 30000); // Auto-save
    </script>
    <script>
        // Register the Service Worker
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
              .then(reg => console.log('Service worker registered.'))
              .catch(err => console.log('Service worker registration failed: ', err));
          });
        }
      </script>
</body>
</html>
